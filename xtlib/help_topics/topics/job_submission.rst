.. _job_submission:

----------------------------
Submitting and Running Jobs
----------------------------

This topic details what happens when you execute the **xt run** command to submit a job to XT.
    - Job Submission
    - Job Running

A job submission consists of four stages.
    - Hyperparameter Search processing
    - Building the Setup Script
    - Building the Code Snapshot
    - Final job submission

<DESCRIBE DEPENDENCIES HERE>

^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Hyperparameter Search Processing
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Hyperparameter search processing consists of the following.
    - Collecting hyperparameter search specs from the script command line and from an `--hp-config` file
    - Determining search style (single, repeat, multi, static, dynamic)
    - Generating static hyperparam_search commands

^^^^^^^^^^^^^^^^^^^^^^^^^^
Building a Setup Script
^^^^^^^^^^^^^^^^^^^^^^^^^^

The setup script defines the cloud computing node to run the XT controller, or, in the case of a direct run, the user's ML app. After this script is built and debugged, it automates the building of the XT cloud controller.

You build a setup script by adding XT commands in a sequence to the script for various needed tasks, depending on the user's config settings and the associated backend cloud services.

Setup script command sets can be grouped into these functions:
    - Setup specifications (activate cmd, Anaconda packages, and python packages)
    - Data/model storage mount and/or file downloads
    - Environment variable settings
    - Launch the XT controller or user application

^^^^^^^^^^^^^^^^^^^^^^^^^
Building a Code Snapshot
^^^^^^^^^^^^^^^^^^^^^^^^^

Every job builds a *code snapshot*. A code snapshot is....<definition here>. <DEPENDENCIES HERE> 
Building the code snapshot consists of the following automated steps:

    - Creation of a temporary directory on the local machine;
    - Processing each entry in the **code-dirs** property of the XT config file. Each code-dirs entry has one of the following string formats:
        - *source* (copies the **source** files (relative to the current directory) to the snapshot root directory, using the basename of the **source** directory, if any);
        - *source::dest* (copies specified **source** files (relative to the current directory) to a snapshot root directory named **dest**);
    - 1-3 other files generated by XT during the job submission are also included in the code snapshot. <What are they?>
        
^^^^^^^^^^^^^^^^^^^^^^^^^
Job Submission
^^^^^^^^^^^^^^^^^^^^^^^^^

Job submission consists of the following automated steps.
    - The submission spawns a new XT job;
    - The job logs a "capture_before" event;
    - The job generates a **job_secret** for subsequent Authenticate Client requests to the XT controller;
    - The job creates an XT Run sequence for each node;
    - The job logs a "created" event for each runa and uploads the code snapshot to job storage;
    - The job loads service configuration parameters using user and XT environment variables; <VERIFY THIS IS CORRECT>
    - The job gets submitted to backend services;
    - The service-id data for the job is written to the job properties (in MongoDB);
    - The job logs a "queued" event for each run.

^^^^^^^^^^^^^^^^^^^^^^^^^
Running a Job
^^^^^^^^^^^^^^^^^^^^^^^^^

After you invoke a job, it goes through the following processes to complete.
    - Backend service processing
        - some services may auto-build docker images for your job (Azure ML)
        - Jobs are queued for running
        - Compute nodes are allocated by the backend service
    - Node preparation
        - After a node is allocated for the job, the service prepares the run environment (including GPUs, port openings, etc.)
    - Node execution
        - XT setup script runs (activate cmd, conda, pip, data/model mount/download)
        - XT Controller starts running (for non-direct runs)
        - The user's script starts running (for direct runs)
    - Node wrapup
        - The job and its services may upload specified output files 

.. seealso:: 

    - :ref:`Hyperparameter Search <hyperparameter_search>`
    - :ref:`How XT Works <how_xt_works>`
    - :ref:`XT Controller <xt_controller>`